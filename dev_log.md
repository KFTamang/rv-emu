# 開発日記
## 2022/06/04
無限ループになる原因を特定した。
x0レジスタを毎回リセットしていなかった。
## 2022/06/05
ログをいい感じに表示して、デバッグの効率を上げたい。
変更があったレジスタの色を変更するとか、変更内容を表示するとか。

いくつかの命令を実装して、のこりはaddの仲間とfence, ecall, ebreak, lui, auipcくらいになってきた。
しかしテストがないのでうまく動いているか自信がない。

## 2022/06/08
ログを出す関数をまとめた。

## 2022/06/10
テスト用バイナリ生成のためにrisc-v tool chainを導入した。WSL上からだとgit clone時に改行文字がcrlfになってうまくいかなかった模様。
一時的に

```
git config --global core.autocrlf false
```

を実行して改行コード変換を無効化したらビルドに成功した。

fizzbuzzを実装したところ、さっそく実装ミスを見つけた。

## 2022/06/12
ログで変更したレジスタを色付き表示するようにした。
かなりみやすくなった。
VSCodeではデフォルトで色付き表示してくれないので、ANSI colorsというエクステンションを導入した。

## 2022/06/19
`riscv64-unknown-elf-objdump`の出力(test.dump)にうまく逆アセンブルされていない命令があった。
見ているとRV64の命令ばかりなので、RV32で逆アセンブルされているような気がする。
`-m riscv:rv64`を指定するとよいらしいので試してみると、見事に全命令が逆アセンブルできた。

## 2022/07/19
ELFファイルを読み込めるようにした。これまでは0番地からいきなり命令が始まるflat binaryしか読み込めなかったため、特殊なオプションをつけてビルドする必要があった。
これでxv6のバイナリが読み込めるようになるはず。

## 2022/07/24
CSRの中身と割込みの実装を始めた。

## 2025/01/04
久しぶりに再開。docker containerを使って開発できるようにしている。
使い方：

- gdb用コンテナイメージビルド
    - `docker build -f Dockerfile.riscv_gdb . -t riscv_gdb`
- コンテナ起動
    - `docker compose up  --remove-orphans --build`
- gdbコンテナ内でのgdb操作
    - `docker exec -it rv-emu-gdb-1 riscv64-unknown-elf-gdb /projects/apps/xv6-riscv/kernel/kernel` で起動
    - `target remote rv-emu-rust-1:9001` を実行
    - `continue` で実行開始

単独でrustコンテナを起動したい場合：
`docker compose run -it --rm rust /bin/bash`

## 2025/01/20
構成を考え直した。
各コンポーネントがバスを経由して割り込み要求を出せるように、バスへのreferenceを持たせる。
複数HartやDMACを追加することも考え、PLICは割り込み先をルーティングできるようにする必要がある。

## 2025/03/12
XV6をフォークしてsubmoduleとした。
ビルド方法：
1. `docker compose run -it --rm gdb /bin/bash`でログイン
2. `make -B`

## 2025/03/59
CSRの調査
- 0x100: sstatus
- 0x104: sie
- 0x14d: stimecmp
- 0x180: satp
- 0x300: mstatus
- 0x302: medeleg
- 0x303: mideleg
- 0x304: mie
- 0x306: mcounteren
- 0x30a: menvcfg
- 0x341: mepc
- 0x3a0: pmpcfg0
- 0x3b0: pmpaddr0
- 0xc01: time

# 2025/03/25
ログをうまく活用できるようにデータベースを整備中。

# 2025/03/28
WSLだとディスクIOが遅くてログが使いにくい。
デバッグ効率を上げる方策を考える。

- 長い実行を毎回しなくてもいいように、スナップショットを保存・復元できるようにする
- ブラウザなどのGUIでレジスタなどの状態を表示する
- 実行状態を保存して、任意のタイミングの状態を表示できる
  - そもそもタイマにスレッドを使うと非決定的になってよくないかもしれない

# 2025/04/01
スナップショットを保存するにあたり、実行を決定論的にするように作り変える。
非決定論的になっているのはスレッドによるタイマー割り込み部分のため、 `DelayedInterrupt` を作成して特定サイクル後の割り込みを予約する。

# 2025/04/21
スナップショットは保存・再開できるようになった。（ただしinterruptキューを除く）
割り込みを予約して保存できるような仕組みを入れたい。
が、うまくインターフェースが設計できない。
各インスタンスにCPUのポインタ(Arc)を持たせればいいが、循環参照になってよくないと思う。

# 2025/04/24
割り込み管理の方針を再検討した。
割りこみのさらに待ちリストが必要なのはタイマーだけなので、割り込み設定のインターフェースだけをCPUに渡すようにする。

# 2025/04/27
再度方針を変更。
やっぱり待ちリストを持つことにする。
